# Implementation Plan: Migrate format-book to UV

**Created**: 2025-11-25
**Status**: Ready for Execution
**Input**: spec.md functional requirements

## Project Overview

### Project Name
`format-book Poetry to UV Migration`

### Problem Statement
Migrate Python project from Poetry to UV package manager for faster dependency resolution.

### Solution Summary
Use automated migration tool to convert Poetry configuration to UV format, validate dependencies resolve correctly, update documentation and workflows.

---

## Summary

Migrate format-book Python project from Poetry package manager to UV. Use `uvx migrate-to-uv` automated tool to convert pyproject.toml from Poetry format ([tool.poetry]) to UV-compatible format ([project]). Replace poetry.lock with uv.lock, preserve all dependencies with major version constraints, update pre-commit hooks to UV-managed version, validate CLI commands work identically.

---

## Technical Implementation

### Technical Context

**Language/Version**: Python 3.13
**Primary Dependencies**: UV package manager (latest), migrate-to-uv tool
**Storage**: File system (pyproject.toml, uv.lock)
**Testing**: pytest (existing test suite)
**Target Platform**: macOS, Linux
**Project Type**: Single Python CLI tool
**Performance Goals**: Migration <5 minutes, dependency sync faster than Poetry
**Constraints**: Preserve exact dependency versions, no code changes
**Scale/Scope**: ~10 dependencies, 3 CLI commands

### Documentation Structure

```
examples/format-book/refactoring/
├── plan.md          # This file
├── research.md      # Migration patterns and UV analysis
├── spec.md          # Functional requirements
└── tasks.md         # Execution tasks (generated by /tasks)
```

### Source Structure (Target Project)

```
/Users/dzianissheka/projects/dev/private/format-book/
├── pyproject.toml      # UV-compatible (after migration)
├── uv.lock             # UV lockfile (after migration)
├── .venv/              # UV-managed venv (after migration)
├── main.py             # CLI entry point (unchanged)
├── src/
│   └── utils/          # Utility modules (unchanged)
├── tests/              # Test suite (unchanged)
├── .pre-commit-config.yaml  # Updated for UV
└── README.md           # Updated with UV commands
```

---

## Phase 0: Research & Validation

**Status**: ✅ Complete (research.md exists)

**Key Decisions**:
- **Migration Tool**: Use automated `uvx migrate-to-uv` (preferred over manual pdm import)
- **Rationale**: Handles standard Poetry configs automatically, 5-minute migration vs 15-30 manual
- **Version Constraints**: Map Poetry caret (^x.y.z) to major version only
- **Pre-commit**: Replace with UV-managed version (current config uses standard hooks, no Poetry references)
- **Jupyter Support**: Not required (ipykernel dependency can be dropped)

**Verified**:
- Current project uses standard poetry-core (no custom plugins)
- Dependencies compatible with UV
- Click CLI works with `uv run` command

---

## Phase 1: Design & Contracts

### Configuration Transformation

**Input Model** (Poetry pyproject.toml):
```toml
[tool.poetry]
name = "format-book"
version = "0.1.0"
description = "Project to format the book with chatgpt"
authors = ["Dzianis Sheka <dzianis.sheka@gmail.com>"]

[tool.poetry.dependencies]
python = "^3.13"
pandas = "^2.2.3"
openai = "^1.54.3"
click = "^8.1.7"
python-dotenv = "^1.0.1"
pre-commit = "^4.0.1"

[tool.poetry.group.dev.dependencies]
flake8 = "^7.1.1"
pytest = ">=7.0.0"
black = "^24.10.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

**Output Model** (UV pyproject.toml):
```toml
[project]
name = "format-book"
version = "0.1.0"
description = "Project to format the book with chatgpt"
authors = [{name = "Dzianis Sheka", email = "dzianis.sheka@gmail.com"}]
requires-python = ">=3.13"
dependencies = [
    "pandas>=2.2.3",
    "openai>=1.54.3",
    "click>=8.1.7",
    "python-dotenv>=1.0.1",
    "pre-commit>=4.0.1",
]

[dependency-groups]
dev = [
    "flake8>=7.1.1",
    "pytest>=7.0.0",
    "black>=24.10.0",
]

[tool.uv]
default-groups = []
```

### Test Scenarios

**Integration Tests** (map from spec acceptance scenarios):

1. **Migration Success**
   - **Given**: Poetry pyproject.toml exists
   - **When**: Run `uvx migrate-to-uv`
   - **Then**: UV pyproject.toml generated with [project] section
   - **Validation**: Parse pyproject.toml, verify [project] exists, [tool.poetry] removed

2. **Dependency Installation**
   - **Given**: Migrated pyproject.toml
   - **When**: Run `uv sync`
   - **Then**: All dependencies install in .venv/
   - **Validation**: Check .venv/lib/python3.13/site-packages/ contains pandas, openai, click

3. **CLI Command Execution**
   - **Given**: UV-managed environment
   - **When**: Run `uv run python main.py generate-stats --help`
   - **Then**: Help text displays (identical to Poetry version)
   - **Validation**: Command exits 0, output contains expected help text

4. **Dependency Management**
   - **Given**: Migrated project
   - **When**: Run `uv add requests`
   - **Then**: pyproject.toml updated, uv.lock regenerated
   - **Validation**: requests in [project.dependencies], uv.lock contains requests entry

5. **Test Suite Execution**
   - **Given**: UV environment
   - **When**: Run `uv run pytest`
   - **Then**: All tests pass
   - **Validation**: pytest exit code 0, no test failures

---

## Phase 2: Task Planning Approach

**Task Generation Strategy**:
- Preparation tasks (backup, UV installation)
- Migration execution (automated tool)
- Validation tasks (config review, dependency sync)
- Testing tasks (CLI commands, test suite)
- Documentation tasks (README, pre-commit config)
- Cleanup tasks (remove old files)

**Ordering Strategy**:
1. Setup (install UV, backup project)
2. Migration (run tool, review output)
3. Validation (sync deps, test resolution)
4. Integration (test CLI, run test suite)
5. Documentation (update README, pre-commit)
6. Cleanup (remove poetry.lock, old venv)

**Estimated Output**: 12-15 tasks

**Note**: Phase 2 executed by `/tasks` command, not `/plan`

---

## Phase 3+: Execution & Validation

**Phase 3**: Execute tasks.md following TDD order
**Phase 4**: Validate all acceptance scenarios pass
**Phase 5**: Commit changes to git

---

## Configuration & Setup

### UV Installation

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### Pre-commit Hook Update

**Current** (.pre-commit-config.yaml):
```yaml
repos:
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v3.2.0
    hooks:
    -   id: trailing-whitespace
    -   id: end-of-file-fixer
    -   id: check-yaml
    -   id: check-added-large-files
-   repo: https://github.com/psf/black
    rev: 22.10.0
    hooks:
    -   id: black
```

**Updated** (UV-managed):
```yaml
repos:
-   repo: https://github.com/astralsh/uv-pre-commit
    rev: 0.4.0
    hooks:
    -   id: uv-lock
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v3.2.0
    hooks:
    -   id: trailing-whitespace
    -   id: end-of-file-fixer
    -   id: check-yaml
    -   id: check-added-large-files
-   repo: https://github.com/psf/black
    rev: 22.10.0
    hooks:
    -   id: black
```

### Command Mapping

| Operation | Poetry | UV |
|-----------|--------|-----|
| Install dependencies | `poetry install` | `uv sync` |
| Add dependency | `poetry add pkg` | `uv add pkg` |
| Remove dependency | `poetry remove pkg` | `uv remove pkg` |
| Run script | `poetry run python main.py` | `uv run python main.py` |
| Run tests | `poetry run pytest` | `uv run pytest` |
| Activate shell | `poetry shell` | `source .venv/bin/activate` |

---

## Integration Points

- **Migration Tool**: `uvx migrate-to-uv` (automated conversion)
- **Fallback Tool**: `uvx pdm import pyproject.toml` (manual conversion if automated fails)
- **Pre-commit**: Add uv-lock hook to validate lockfile on commit
- **CI/CD**: Update GitHub Actions (if exists) to use `uv sync` instead of `poetry install`

---

## Success Criteria

### ✅ Core Functionality
- UV-compatible pyproject.toml generated with [project] section
- All dependencies resolve without conflicts
- uv.lock created successfully
- .venv/ populated with correct packages

### ✅ Quality & Reliability
- All CLI commands work identically (`generate-stats`, `format-folder`, `combine-chapters`)
- pytest suite passes (exit code 0)
- No import errors when running scripts
- Pre-commit hooks execute successfully

### ✅ Operations
- README.md updated with UV commands
- poetry.lock and old .venv/ removed
- Migration validated via test execution
- Changes committed to git with clear commit message

---

## Example Usage

### Migration Process

```bash
# 1. Navigate to project
cd /Users/dzianissheka/projects/dev/private/format-book

# 2. Backup (git commit)
git add . && git commit -m "Pre-migration backup"

# 3. Install UV
curl -LsSf https://astral.sh/uv/install.sh | sh

# 4. Run migration
uvx migrate-to-uv

# 5. Review changes
cat pyproject.toml

# 6. Clean old files
rm -rf .venv poetry.lock

# 7. Sync dependencies
uv sync

# 8. Test commands
uv run python main.py --help
uv run pytest

# 9. Update pre-commit
# Edit .pre-commit-config.yaml (add uv-lock hook)

# 10. Update README
# Replace Poetry commands with UV equivalents
```

### Post-Migration Workflow

```bash
# Install dependencies
uv sync

# Run CLI commands
uv run python main.py generate-stats input/ output/
uv run python main.py format-folder input/ output/
uv run python main.py combine-chapters input/

# Run tests
uv run pytest

# Add new dependency
uv add requests

# Activate environment for interactive work
source .venv/bin/activate
```

---

## Additional Context

### Design Decisions

**Migration Approach**: Automated tool preferred
- **Decision**: Use `uvx migrate-to-uv`
- **Rationale**: 5-minute migration vs 15-30 manual, handles standard configs
- **Risk Mitigation**: Fallback to manual `uvx pdm import` if automated fails

**Version Constraints**: Major version only
- **Decision**: Convert ^2.2.3 → >=2.2.3 (major version)
- **Rationale**: User requirement for major version mapping only
- **Trade-off**: Less restrictive than Poetry caret, but simpler

**Pre-commit Strategy**: Add UV validation
- **Decision**: Add uv-lock hook to validate lockfile
- **Rationale**: Ensures lockfile stays in sync with pyproject.toml
- **Alternative Rejected**: Keeping current hooks only (no lockfile validation)

### Reference Documentation

- [UV Documentation](https://docs.astral.sh/uv)
- [Migration Guide](https://www.loopwerk.io/articles/2024/migrate-poetry-to-uv/)
- [UV Pre-commit Hook](https://github.com/astralsh/uv-pre-commit)
- [migrate-to-uv Tool](https://pypi.org/project/poetry-to-uv/)

### Known Limitations

- First `uv sync` may be slow (downloading packages); subsequent syncs instant
- UV cache stored globally (~/.cache/uv/), not project-local
- Manual review of pyproject.toml required after automated migration
- Conflicting dependencies must be resolved manually if migration tool reports errors

---

## Requirement Mapping (Spec → Plan)

| Spec Requirement | Technical Implementation |
|------------------|--------------------------|
| FR-001: Accept pyproject.toml | `uvx migrate-to-uv` reads Poetry config |
| FR-003: Preserve Python ^3.13 | Convert to requires-python = ">=3.13" |
| FR-006: Map major version | Caret ^2.2.3 → >=2.2.3 |
| FR-007: Produce UV pyproject.toml | [project] section with dependencies array |
| FR-008: Generate uv.lock | `uv sync` creates lockfile |
| FR-012: Convert constraints | >= format for all dependencies |
| FR-014: Remove Poetry sections | Delete [tool.poetry], [build-system] |
| FR-017: Create virtual environment | `uv sync` creates .venv/ |
| FR-024: Sync dependencies | `uv sync` command |
| FR-026: Run CLI commands | `uv run python main.py [cmd]` |
| FR-031: Validate syntax | `uvx migrate-to-uv` validates before conversion |
| FR-034: Resolve conflicts | Manual resolution if tool reports errors |
| FR-044: Replace pre-commit | Add uv-lock hook to config |
